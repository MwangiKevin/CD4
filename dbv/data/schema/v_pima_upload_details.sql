CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v_pima_upload_details` AS select `pim_upl`.`id` AS `upload_id`,`pim_upl`.`upload_date` AS `upload_date`,`pim_upl`.`facility_pima_id` AS `facility_pima_id`,`pim_upl`.`uploaded_by` AS `uploaded_by_id`,`usr`.`username` AS `uploaded_by_username`,`usr`.`name` AS `uploaded_by_name`,`fac_eq`.`id` AS `id`,`fac_eq`.`serial_number` AS `serial_number`,`fac_pim`.`serial_num` AS `serial_num`,`fac_pim`.`ctc_id_no` AS `ctc_id_no`,concat(year(`pim_upl`.`upload_date`),'-',month(`pim_upl`.`upload_date`)) AS `upload_yearmonth`,sum((case when (`tst`.`valid` = '1') then 1 else 0 end)) AS `valid`,sum((case when (`tst`.`valid` = '0') then 1 else 0 end)) AS `errors`,sum((case when ((`tst`.`valid` = '1') and (`tst`.`cd4_count` < 350)) then 1 else 0 end)) AS `failed`,sum((case when ((`tst`.`valid` = '1') and (`tst`.`cd4_count` >= 350)) then 1 else 0 end)) AS `passed`,`fac`.`id` AS `facility_id`,`fac`.`name` AS `facility_name`,`fac`.`email` AS `facility_email`,`fac`.`phone` AS `facility_phone`,`fac`.`rollout_status` AS `facility_rollout_id`,`st`.`desc` AS `facility_rollout_status`,`fac`.`rollout_date` AS `facility_rollout_date`,`fac`.`district_id` AS `district_id`,`dis`.`name` AS `district_name`,`dis`.`status` AS `district_status`,`dis`.`region_id` AS `region_id`,`reg`.`name` AS `region_name`,`reg`.`fusion_id` AS `region_fusion_id`,`par_reg`.`partner_id` AS `partner_id`,`par`.`name` AS `partner_name`,`par`.`email` AS `partner_email`,`par`.`phone` AS `partner_phone` from (((((((((((`cd4_test` `tst` left join `pima_test` `pim_tst` on((`tst`.`id` = `pim_tst`.`cd4_test_id`))) left join `pima_upload` `pim_upl` on((`pim_tst`.`pima_upload_id` = `pim_upl`.`id`))) left join `facility_pima` `fac_pim` on((`pim_upl`.`facility_pima_id` = `fac_pim`.`id`))) left join `facility_equipment` `fac_eq` on((`fac_pim`.`facility_equipment_id` = `fac_eq`.`id`))) left join `facility` `fac` on((`tst`.`facility_id` = `fac`.`id`))) left join `district` `dis` on((`fac`.`district_id` = `dis`.`id`))) left join `region` `reg` on((`dis`.`region_id` = `reg`.`id`))) left join `partner_regions` `par_reg` on((`reg`.`id` = `par_reg`.`region_id`))) left join `partner` `par` on((`par_reg`.`partner_id` = `par`.`id`))) left join `status` `st` on((`fac`.`rollout_status` = `st`.`id`))) left join `user` `usr` on((`pim_upl`.`uploaded_by` = `usr`.`id`))) group by `upload_yearmonth`,`fac`.`id` order by `upload_id` desc