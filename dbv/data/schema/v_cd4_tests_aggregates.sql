CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v_cd4_tests_aggregates` AS select `tst`.`result_date` AS `result_date`,month(`tst`.`result_date`) AS `month`,year(`tst`.`result_date`) AS `year`,count(distinct `fac`.`name`) AS `facilities_reported`,count(`tst`.`id`) AS `total_tests`,sum((case when (`tst`.`valid` = '1') then 1 else 0 end)) AS `valid`,sum((case when (`tst`.`valid` = '0') then 1 else 0 end)) AS `errors`,sum((case when ((`tst`.`valid` = '1') and (`tst`.`cd4_count` < 350)) then 1 else 0 end)) AS `failed`,sum((case when ((`tst`.`valid` = '1') and (`tst`.`cd4_count` >= 350)) then 1 else 0 end)) AS `passed`,concat(year(`tst`.`result_date`),'-',month(`tst`.`result_date`)) AS `yearmonth` from (`cd4_test` `tst` left join `facility` `fac` on((`tst`.`facility_id` = `fac`.`id`))) group by `yearmonth` order by `tst`.`result_date` desc